@page "/admin"
@page "/admin/dashboard"
@layout AdminLayout
@attribute [Authorize]
@using WhatsAppBot.Models
@using WhatsAppBot.Data.DTOs
@inject IDashboardService DashboardService
@inject IPedidoService PedidoService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ILogger<Dashboard> Logger

<PageTitle>Dashboard - Panel Administrativo</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">
    ðŸ“Š Dashboard Administrativo
</MudText>

@if (isLoading)
{
    <MudContainer Class="d-flex justify-center align-center" Style="height: 50vh;">
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
        <MudText Class="ml-3">Cargando datos del dashboard...</MudText>
    </MudContainer>
}
else if (hasError)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        <MudText>Error al cargar el dashboard. Mostrando datos por defecto.</MudText>
        <MudButton OnClick="RetryLoad" Variant="Variant.Text" Size="Size.Small">
            Reintentar
        </MudButton>
    </MudAlert>
}
else
{
    <!-- InformaciÃ³n de Ãºltima actualizaciÃ³n -->
    <MudAlert Severity="Severity.Info" Class="mb-4">
        <MudText Typo="Typo.caption">
            Ãšltima actualizaciÃ³n: @_metricas.FechaActualizacion.ToString("dd/MM/yyyy HH:mm:ss")
        </MudText>
    </MudAlert>

    <!-- Tarjetas de MÃ©tricas -->
    <MudGrid Class="mb-6">
        <!-- Pedidos Hoy -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="position-relative" Style="height: 150px;">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.h4" Color="Color.Primary">
                                @_metricas.PedidosHoy
                            </MudText>
                            <MudText Typo="Typo.body2">
                                Pedidos Hoy
                            </MudText>
                        </div>
                        <div>
                            <MudIcon Icon="Icons.Material.Filled.ShoppingCart" 
                                   Size="Size.Large" 
                                   Color="Color.Primary" />
                        </div>
                    </div>
                    <div class="mt-2">
                        <MudText Typo="Typo.caption" 
                               Color="@(_metricas.PedidosTrend >= 0 ? Color.Success : Color.Error)">
                            @(_metricas.PedidosTrend >= 0 ? "â†—" : "â†˜") @_metricas.PedidosTrend.ToString("F1")%
                        </MudText>
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Conversaciones Activas -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="height: 150px;">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.h4" Color="Color.Info">
                                @_metricas.ConversacionesActivas
                            </MudText>
                            <MudText Typo="Typo.body2">
                                Conversaciones Activas
                            </MudText>
                        </div>
                        <div>
                            <MudIcon Icon="Icons.Material.Filled.Chat" 
                                   Size="Size.Large" 
                                   Color="Color.Info" />
                        </div>
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Clientes Nuevos -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="height: 150px;">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.h4" Color="Color.Success">
                                @_metricas.ClientesNuevos
                            </MudText>
                            <MudText Typo="Typo.body2">
                                Clientes Nuevos (7 dÃ­as)
                            </MudText>
                        </div>
                        <div>
                            <MudIcon Icon="Icons.Material.Filled.PersonAdd" 
                                   Size="Size.Large" 
                                   Color="Color.Success" />
                        </div>
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Mensajes -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="height: 150px;">
                <MudCardContent>
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.h4" Color="Color.Warning">
                                @_metricas.MensajesEnviados
                            </MudText>
                            <MudText Typo="Typo.body2">
                                Mensajes Enviados Hoy
                            </MudText>
                            <MudText Typo="Typo.caption">
                                Recibidos: @_metricas.MensajesRecibidos
                            </MudText>
                        </div>
                        <div>
                            <MudIcon Icon="Icons.Material.Filled.Message" 
                                   Size="Size.Large" 
                                   Color="Color.Warning" />
                        </div>
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Pedidos Recientes -->
    <MudGrid>
        <MudItem xs="12" md="8">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">ðŸ“¦ Pedidos Recientes</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_pedidosRecientes?.Any() == true)
                    {
                        <MudSimpleTable Dense="true">
                            <thead>
                                <tr>
                                    <th>Folio</th>
                                    <th>Cliente</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var pedido in _pedidosRecientes.Take(5))
                                {
                                    <tr>
                                        <td>@pedido.Folio</td>
                                        <td>@pedido.ClienteNombre</td>
                                        <td>
                                            <MudChip T="string" Size="Size.Small" 
                                                   Color="GetEstadoColor(pedido.Estado)">
                                                @pedido.Estado
                                            </MudChip>
                                        </td>
                                        <td>@pedido.FechaPedido.ToString("dd/MM HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    }
                    else
                    {
                        <MudText>No hay pedidos recientes</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">ðŸ“Š Estados de Pedidos</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (_estadosPedidos?.Any() == true)
                    {
                        @foreach (var estado in _estadosPedidos)
                        {
                            <div class="mb-3">
                                <div class="d-flex justify-space-between">
                                    <MudText Typo="Typo.body2">@estado.Estado</MudText>
                                    <MudText Typo="Typo.body2">@estado.Cantidad</MudText>
                                </div>
                                <MudProgressLinear Value="estado.Porcentaje" 
                                                 Color="GetMudColor(estado.Color)" />
                            </div>
                        }
                    }
                    else
                    {
                        <MudText>No hay datos de estados</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}

@code {
    private DashboardMetricsDTO _metricas = new();
    private List<PedidoRecenteDTO> _pedidosRecientes = new();
    private List<EstadoPedidoMetricDTO> _estadosPedidos = new();
    
    private bool isLoading = true;
    private bool hasError = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardDataSafe();
    }

    // âœ… SOLUCIÃ“N: Carga secuencial y fail-safe
    private async Task LoadDashboardDataSafe()
    {
        isLoading = true;
        hasError = false;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Iniciando carga del dashboard");

            // âœ… Ejecutar secuencialmente para evitar problemas de concurrencia
            _metricas = await DashboardService.GetMetricsAsync();
            Logger.LogInformation("MÃ©tricas cargadas exitosamente");

            _pedidosRecientes = await DashboardService.GetPedidosRecientesAsync(10);
            Logger.LogInformation("Pedidos recientes cargados: {Count}", _pedidosRecientes.Count);

            _estadosPedidos = await DashboardService.GetPedidosEstadisticasAsync();
            Logger.LogInformation("Estados de pedidos cargados: {Count}", _estadosPedidos.Count);

            Logger.LogInformation("Dashboard cargado completamente");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar datos del dashboard");
            hasError = true;
            
            // Datos por defecto para que la pÃ¡gina funcione
            _metricas = new DashboardMetricsDTO
            {
                PedidosHoy = 0,
                PedidosTrend = 0,
                ConversacionesActivas = 0,
                ClientesNuevos = 0,
                MensajesEnviados = 0,
                MensajesRecibidos = 0,
                FechaActualizacion = DateTime.Now
            };
            _pedidosRecientes = new List<PedidoRecenteDTO>();
            _estadosPedidos = new List<EstadoPedidoMetricDTO>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RetryLoad()
    {
        await LoadDashboardDataSafe();
    }

    private Color GetEstadoColor(string estado) => estado switch
    {
        "En espera" => Color.Warning,
        "En proceso" => Color.Info,
        "Entregado" => Color.Success,
        "Cancelado" => Color.Error,
        "Pendiente" => Color.Default,
        _ => Color.Secondary
    };

    private MudBlazor.Color GetMudColor(string color) => color switch
    {
        "warning" => MudBlazor.Color.Warning,
        "info" => MudBlazor.Color.Info,
        "success" => MudBlazor.Color.Success,
        "error" => MudBlazor.Color.Error,
        "default" => MudBlazor.Color.Default,
        _ => MudBlazor.Color.Secondary
    };

    public void Dispose()
    {
        // No SignalR por ahora para simplificar
    }
}